{% extends 'layout/basic.html' %}
{% load static %}
{% block title %}
	<title>用户注册</title>
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/verify-register.css' %}">
{% endblock %}

{% block content %}

<div class="account">
    <form method="post">
    {% csrf_token %}
     <h1 class="title">用户注册</h1>
    {% for foo in form %}
        {% csrf_token %}
            {% if foo.name == "code" %}
                <div class="form-group">
                    <label for="{{ foo.id_for_label }}"  >{{ foo.label }}:</label>
                    <div class="clearfix">
                        <div class="col-md-6" style="padding-left: 0">
                            {{ foo }}
                            <span class="error-msg"></span>
                        </div>
                        <div class="col-md-6"><input type="button" id="sendEmail" class="btn btn-default" value="点击获取验证码" onclick="getCode()"> </div>
                    </div>
                </div>
            {% else %}
                <div class="mb-3">
                    <label for="{{ foo.id_for_label }}" >{{ foo.label }}:</label>
                    {{ foo }}
                    <span class="error-msg"></span>
                </div>
            {% endif %}
            <div style="height: 13px"></div>
    {% endfor %}
    <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

{% endblock %}

{% block js %}
<script>
    function getCode() {
        // 获取邮箱
        // var email = document.getElementById("id_email").value;
        var email = $('#id_email').val();
        $('.error-msg').empty();   //每次点击请空 提示 span 中的内容
        // console.log(email);
        // 使用AJAX发送邮箱地址到服务器
        $.ajax({
            // 反向成功url = 'http://127.0.0.1:8000/send_email_info/'
            url : "{% url 'web:send_email' %}",
            type : "GET",
            data : {"email" : email, "tpl":"register"},
            dataType:"JSON",
            success:function (res) {
                // ajax 发送成功后，自动执行的函数
                // res 为后端返回的值
                if (res.status){
                    sendEmailRemind();
                }else{
                    //错误信息
                    $.each(res.error, function (key,value){
                        console.log(key, value[0]);
                        $('#id_' + key).next().text("*"+value[0]);
                    })
                }

            }
        });
    }
    
    // 重新发送倒计时
    function sendEmailRemind() {
        var $sendEmail = $("#sendEmail");
        $sendEmail.prop('disabled',true);
        var time = 6;
        var remid = setInterval(function () {
            $sendEmail.val(time+"后重新发送");
            time = time - 1 ;
            if (time < 0){
                clearInterval(remid);   // 取消定时器
                $sendEmail.val("点击获取验证码").prop("disabled", false)
            }
        },1000)
    }
</script>

{% endblock %}

